<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0 fw-bold text-primary">Quản lý đơn đặt hàng nhà cung cấp</h2>
  </div>

  <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr class="text-secondary fw-semibold">
              <th class="ps-4">ID Đơn</th>
              <th>Người lập</th>
              <th>Ngày nhập</th>
              <th>Ghi chú</th>
              <th class="text-center">Hóa đơn</th>
              <th class="text-center">Hành động</th>
            </tr>
          </thead>
          <tbody>
            @for (order of purchaseOrders; track order.id) {
            <tr class="border-bottom">
              <td class="ps-4 fw-medium">#{{ order.id }}</td>
              <td>
                <div>{{ order.userResponse.fullName }}</div>
                <small class="text-muted">{{ order.userResponse.phoneNumber }}</small>
              </td>
              <td>{{ order.importDate | date:'dd/MM/yyyy HH:mm' }}</td>
              <td>
                @if(order.note) {
                <small>{{ order.note}}</small>
                } @else {
                <span class="text-danger">Không ghi chú</span>
                }
              </td>
              <td class="text-center">
                @if (order.receiptFile) {
                <button type="button" class="btn btn-download" (click)="downloadPdf(order.receiptFile,order.id)">
                  <i class="fas fa-download"></i>
                  Tải xuống PDF
                </button>

                <!-- NÚT IN CHỈ IN PDF (bypass cross-origin) -->
                <button type="button" class="btn btn-print" (click)="printPdfOnly(order.receiptFile)">
                  <i class="fas fa-print"></i>
                  In hóa đơn
                </button>
                } @else {
                <span class="text-muted small">Chưa có</span>
                }
              </td>
              <td class="text-center">
                <button class="btn btn-outline-info btn-sm" title="Xem chi tiết" (click)="toggleDetails(order.id)">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>

            <!-- Chi tiết sản phẩm (expand khi bấm xem) -->
            @if (expandedOrderId === order.id) {
            <tr>
              <td colspan="9" class="p-0">
                <div class="bg-light p-4">
                  <h6 class="fw-bold mb-3 text-primary">Chi tiết sản phẩm trong đơn</h6>
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                      <thead class="table-secondary">
                        <tr>
                          <th>STT</th>
                          <th>Ảnh</th>
                          <th>Tên sản phẩm</th>
                          <th class="text-center">SL</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (detail of order.purchaseOrderDetailResponses; track detail.productResponse.id; let i =
                        $index) {
                        <tr>
                          <td>{{ i + 1 }}</td>
                          <td>
                            <img [src]="getImageUrl(detail.productResponse.thumbnail)" width="50" height="50"
                              class="rounded" [alt]="detail.productResponse.name">
                          </td>
                          <td class="fw-medium">{{ detail.productResponse.name }}</td>
                          <td class="text-center">{{ detail.quantity }}</td>
                        </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              </td>
            </tr>
            }
            } @empty {
            <tr>
              <td colspan="9" class="text-center py-5 text-muted">
                <i class="fas fa-clipboard-list fa-3x mb-3 opacity-50"></i><br>
                Chưa có đơn đặt hàng nào từ nhà cung cấp
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>